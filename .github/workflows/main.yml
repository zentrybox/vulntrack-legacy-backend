name: ðŸš€ VulnTrack CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ==========================================
  # Code Quality Check
  # ==========================================
  quality:
    name: ðŸ” Code Quality
    uses: ./.github/workflows/code-quality.yml

  # ==========================================
  # Test Suite
  # ==========================================
  test:
    name: ðŸ§ª Tests
    uses: ./.github/workflows/test.yml
    needs: quality

  # ==========================================
  # Build Docker Image
  # ==========================================
  build:
    name: ðŸ³ Build
    uses: ./.github/workflows/build.yml
    needs: [quality, test]
    if: github.event_name == 'push'

  # ==========================================  # ==========================================
  # Deploy to Staging
  # ==========================================
  deploy-staging:
    name: ðŸ§ª Deploy Staging
    uses: ./.github/workflows/deploy-simple.yml
    needs: [quality, test, build]
    if: github.ref == 'refs/heads/develop'
    with:
      environment: staging
      image-tag: develop-latest
    secrets: inherit

  # ==========================================
  # Deploy to Production
  # ==========================================
  deploy-production:
    name: ðŸš€ Deploy Production
    uses: ./.github/workflows/deploy-simple.yml
    needs: [quality, test, build]
    if: github.ref == 'refs/heads/main'
    with:
      environment: production
      image-tag: main-latest
    secrets: inherit

  # ==========================================
  # Pipeline Summary
  # ==========================================
  summary:
    name: ðŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [quality, test, build, deploy-staging, deploy-production]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate Pipeline Summary
      run: |
        echo "# ðŸš€ VulnTrack CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š Pipeline Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Stage | Status | Duration |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” Code Quality | ${{ needs.quality.result == 'success' && 'âœ… PASSED' || needs.quality.result == 'skipped' && 'â­ï¸ SKIPPED' || 'âŒ FAILED' }} | - |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ª Tests | ${{ needs.test.result == 'success' && 'âœ… PASSED' || needs.test.result == 'skipped' && 'â­ï¸ SKIPPED' || 'âŒ FAILED' }} | - |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ³ Build | ${{ needs.build.result == 'success' && 'âœ… SUCCESS' || needs.build.result == 'skipped' && 'â­ï¸ SKIPPED' || 'âŒ FAILED' }} | - |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ª Staging Deploy | ${{ needs.deploy-staging.result == 'success' && 'âœ… DEPLOYED' || needs.deploy-staging.result == 'skipped' && 'â­ï¸ SKIPPED' || 'âŒ FAILED' }} | - |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸš€ Production Deploy | ${{ needs.deploy-production.result == 'success' && 'âœ… DEPLOYED' || needs.deploy-production.result == 'skipped' && 'â­ï¸ SKIPPED' || 'âŒ FAILED' }} | - |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Overall status
        if [[ "${{ needs.quality.result }}" == "success" && "${{ needs.test.result }}" == "success" ]]; then
          if [[ "${{ github.event_name }}" == "push" && "${{ needs.build.result }}" == "success" ]]; then
            echo "## ðŸŽ‰ Pipeline completed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ¯ Next Steps:" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
              echo "- âœ… Code is ready for testing in staging environment" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸ”„ Consider creating a PR to main for production deployment" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
              echo "- âœ… Code has been deployed to production" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸ“Š Monitor application health and performance" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## âœ… Quality checks passed!" >> $GITHUB_STEP_SUMMARY
            echo "- All code quality and tests are passing" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "## âŒ Pipeline failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Issues to fix:" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.quality.result }}" != "success" ]]; then
            echo "- ðŸ” Code quality issues need to be resolved" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "- ðŸ§ª Test failures need to be fixed" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ needs.build.result }}" == "failure" ]]; then
            echo "- ðŸ³ Docker build issues need to be resolved" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # Add useful links
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Useful Links:" >> $GITHUB_STEP_SUMMARY
        echo "- [Repository](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
        echo "- [Actions](https://github.com/${{ github.repository }}/actions)" >> $GITHUB_STEP_SUMMARY
        echo "- [Security](https://github.com/${{ github.repository }}/security)" >> $GITHUB_STEP_SUMMARY
